# SPDX-FileCopyrightText: 2021 Oxhead Alpha
# SPDX-License-Identifier: LicenseRef-MIT-OA

env:
  SET_VERSION: "export OCTEZ_VERSION=\"$(cat meta.json | jq -r '.tezos_ref' | cut -d'/' -f3)\""
  USE_NEWER_NIX: 1

steps:
 - label: Build Big Sur x86_64 bottles
   key: build-bottles-big-sur-x86_64
   if: build.branch == "pasqu4le/tmp"
   agents:
     queue: "x86_64-rosetta-darwin"
   commands:
   - nix develop .#autorelease-macos -c ./scripts/build-all-bottles.sh "big_sur"
   artifact_paths:
     - '*.bottle.*'
   retry:
     automatic:
       limit: 1

 # To avoid running two brew processes together
 - wait

 - label: Build Big Sur arm64 bottles
   key: build-bottles-big-sur-arm64
   if: build.branch == "pasqu4le/tmp"
   agents:
     queue: "arm64-darwin"
   commands:
   - nix develop .#autorelease-macos -c ./scripts/build-all-bottles.sh "arm64_big_sur"
   artifact_paths:
     - '*.bottle.*'
   retry:
     automatic:
       limit: 1

 - label: Add Big Sur bottle hashes to formulae
   depends_on:
   - "build-bottles-big-sur-arm64"
   - "build-bottles-big-sur-x86_64"
   if: build.branch == "pasqu4le/tmp"
   soft_fail: true # No artifacts to download if all the bottles are already built
   commands:
   - mkdir -p "Big Sur"
   - buildkite-agent artifact download "*bottle.tar.gz" "Big Sur/"
   - nix develop .#autorelease -c ./scripts/sync-bottle-hashes.sh "v16.0-rc1-1" "Big Sur"
